
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Shared Singleton's - Confessions of a Wall Street Programmer</title>
  <meta name="author" content="Bill Torpey">

  
  <meta name="description" content="How to properly manage singleton lifetime using shared_ptr's">
  <meta name="keywords" content="c++, singleton, shared_ptr">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://btorpey.github.io/blog/2014/02/12/shared-singletons">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Confessions of a Wall Street Programmer" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-61420123-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <link href="/stylesheets/print.css" media="print" rel="stylesheet" type="text/css">  
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Confessions of a Wall Street Programmer</a></h1>
  
    <h2>practical ideas (and perhaps some uncommon knowledge) on software architecture, design, construction and testing</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:btorpey.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Shared Singleton's</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-12T00:00:00-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img class="left" src="/images/caddyshack-11.jpg" width="320" height="240" /></p>

<p>Singleton’s are kind of like Rodney Dangerfield – they don’t get no respect. And
yet, there are scenarios where a singleton is just the ticket – for instance,
when a relatively expensive and/or long-lived resource needs to be shared among
a number of independent threads.</p>

<p>shared_ptr’s can help make this easier and less error-prone, but even so there are some 
edge cases that need to be considered.</p>

<!--more-->

<p>In our case, we had a need for a singleton object to refer to a middleware
connection which was being shared across a large number of child objects, which
were in turn being manipulated on a number of different threads.</p>

<p>In our case, we also wanted lazy initialization (construct on first use), and to
clean up the singleton properly when the code was done using it. Since the
creation and destruction order of the using objects is not deterministic, the
obvious solution is to use reference counting to manage the singleton’s lifetime,
and the simplest way to do that is to use <a href="http://www.cplusplus.com/reference/memory/shared_ptr/">shared_ptr’s</a>.</p>

<p>shared_ptr’s were introduced in Boost, and were subsequently adopted by the C++
standards committee as part of the base language with the tr1 and C++0x
standards. As such, they have been widely supported (think gcc and MS compilers)
for a while now.</p>

<p>One of the “magic” qualities of shared_ptr’s is that all shared_ptr’s that point
to the same thing (what I’m going to refer to as a “target” from here on) share
a single reference count (hence the “shared” part of the name), so as individual
shared_ptr’s go out of scope, the reference counter on the target itself is
automatically decremented, and the target is deleted when its reference count
goes to zero.</p>

<p>However, as we’ll see, there are some fine points that need to be considered
even in this relatively simple case.</p>

<p>Our first attempt looked something like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span> (smart1.cpp)</span> <a href="/downloads/code/smart/smart1.cpp">download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
</pre></td><td class="code"><pre><code class="cpp"><span class="line"><span class="cp">#include &lt;iostream&gt;</span>
</span><span class="line"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class="line"><span class="cp">#include &lt;tr1/memory&gt;</span>
</span><span class="line"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">tr1</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="k">struct</span> <span class="n">SharedClass</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">SharedClass</span><span class="p">();</span>
</span><span class="line">   <span class="o">~</span><span class="n">SharedClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line"><span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="n">SharedClass</span><span class="o">::</span><span class="n">SharedClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SharedClass ctor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">SharedClass</span><span class="o">::~</span><span class="n">SharedClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SharedClass dtor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">struct</span> <span class="n">ContainerClass</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="o">~</span><span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">getShared</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">memberPtr</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">	<span class="k">static</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span>  <span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line"><span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span>   <span class="n">ContainerClass</span><span class="o">::</span><span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">ContainerClass</span><span class="o">::</span><span class="n">getShared</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">masterPtr</span><span class="p">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
</span><span class="line">      <span class="n">masterPtr</span> <span class="o">=</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">SharedClass</span><span class="p">());</span>
</span><span class="line">   <span class="p">}</span>
</span><span class="line">
</span><span class="line">   <span class="k">return</span> <span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">ContainerClass</span><span class="o">::</span><span class="n">ContainerClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ContainerClass ctor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">before</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">memberPtr</span> <span class="o">=</span> <span class="n">getShared</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">after</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">ContainerClass</span><span class="o">::~</span><span class="n">ContainerClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ContainerClass dtor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">before</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Entering main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass1</span><span class="p">;</span>
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass2</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass3</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exiting main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The implementation constructs the singleton into a class-static shared_ptr on
the first call to getShared(), and then hands out copies of the shared_ptr to
each caller. When run, the following output is produced:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span> (smart1.out)</span> <a href="/downloads/code/smart/smart1.out">download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="console"><span class="line"><span class="go">Entering main</span>
</span><span class="line"><span class="go">ContainerClass ctor:0x154b9010</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 0</span>
</span><span class="line"><span class="go">SharedClass ctor:0x154b9030</span>
</span><span class="line"><span class="go">	after	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass ctor:0x154b90a0</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 2</span>
</span><span class="line"><span class="go">	after	copy: 3	master: 3</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x154b9010</span>
</span><span class="line"><span class="go">	before	copy: 3	master: 3</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x154b90a0</span>
</span><span class="line"><span class="go">	before	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass ctor:0x154b90a0</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 1</span>
</span><span class="line"><span class="go">	after	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x154b90a0</span>
</span><span class="line"><span class="go">	before	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">Exiting main</span>
</span><span class="line"><span class="go">SharedClass dtor:0x154b9030</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This implementation works, but with one major caveat: as you can see from the
output, the shared_ptr’s get an initial reference count of two – one for the
creation of the singleton itself, and one for the copy of the shared_ptr that is
returned from getShared.</p>

<p>This means that the singleton will not actually be deleted until after returning
from main(), which is when static objects get deleted. (For more information on
why this is so, see section 3.6.3 of the C++ standard).<sup id="fnref:2"><a href="#fn:2" rel="footnote">1</a></sup> In many cases, that
would not be a problem, but in our case the middleware connection to which the
shared_ptr’s refer gets cleaned up in the main thread prior to returning, and so
the final destructor referred to an object that was no longer valid.</p>

<p>Another issue has to do with RAII <sup id="fnref:1"><a href="#fn:1" rel="footnote">2</a></sup> – if you’re relying on the destruction
of the target to release resources, the fact that the target is effectively
never deleted is a potential problem.</p>

<p>Last but not least is the issue of overall tidiness – given that the shared
object is allocated within the scope of main(), it just seems wrong to let it go
out of scope after main() exits. Ideally, we’d like to destroy the shared object
prior to returning from main(), but how to do that?</p>

<p>Our next attempt looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span> (smart2.cpp)</span> <a href="/downloads/code/smart/smart2.cpp">download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
</pre></td><td class="code"><pre><code class="cpp"><span class="line"><span class="cp">#include &lt;iostream&gt;</span>
</span><span class="line"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class="line"><span class="cp">#include &lt;tr1/memory&gt;</span>
</span><span class="line"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">tr1</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="k">struct</span> <span class="n">SharedClass</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">SharedClass</span><span class="p">();</span>
</span><span class="line">   <span class="o">~</span><span class="n">SharedClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line"><span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="n">SharedClass</span><span class="o">::</span><span class="n">SharedClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SharedClass ctor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">SharedClass</span><span class="o">::~</span><span class="n">SharedClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SharedClass dtor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">struct</span> <span class="n">ContainerClass</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="o">~</span><span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">getShared</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">memberPtr</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">	<span class="k">static</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span>  <span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line"><span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span>   <span class="n">ContainerClass</span><span class="o">::</span><span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">ContainerClass</span><span class="o">::</span><span class="n">getShared</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">masterPtr</span><span class="p">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
</span><span class="line">      <span class="n">masterPtr</span> <span class="o">=</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">SharedClass</span><span class="p">());</span>
</span><span class="line">   <span class="p">}</span>
</span><span class="line">
</span><span class="line">   <span class="k">return</span> <span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">ContainerClass</span><span class="o">::</span><span class="n">ContainerClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ContainerClass ctor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">before</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">memberPtr</span> <span class="o">=</span> <span class="n">getShared</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">after</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">ContainerClass</span><span class="o">::~</span><span class="n">ContainerClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ContainerClass dtor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">before</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">memberPtr</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span><span class="line">   <span class="k">if</span> <span class="p">(</span><span class="n">masterPtr</span><span class="p">.</span><span class="n">unique</span><span class="p">())</span>
</span><span class="line">      <span class="n">masterPtr</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">after</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Entering main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass1</span><span class="p">;</span>
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass2</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass3</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exiting main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In the destructor for the container class, we first reset() the container’s copy
of the shared_ptr. This reduces its reference count to zero, and also decrements
the reference counter on the static shared_ptr that was initialized when the
singleton was created. (The destructor of the container’s copy of the shared_ptr
will still be executed on return from the container’s destructor, but since the
reference count is already zero, it will do nothing).</p>

<p>Then we test the static shared_ptr to see if it’s reference count is equal to
one (by calling unique()), and if it is we call reset on it to decrement its
reference count once again, which ends up deleting the singleton (since the
reference count is now zero).</p>

<p>When we run this version of the code, we see the following output:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span> (smart2.out)</span> <a href="/downloads/code/smart/smart2.out">download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="console"><span class="line"><span class="go">Entering main</span>
</span><span class="line"><span class="go">ContainerClass ctor:0x642f010</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 0</span>
</span><span class="line"><span class="go">SharedClass ctor:0x642f030</span>
</span><span class="line"><span class="go">	after	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass ctor:0x642f0a0</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 2</span>
</span><span class="line"><span class="go">	after	copy: 3	master: 3</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x642f010</span>
</span><span class="line"><span class="go">	before	copy: 3	master: 3</span>
</span><span class="line"><span class="go">	after	copy: 0	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x642f0a0</span>
</span><span class="line"><span class="go">	before	copy: 2	master: 2</span>
</span><span class="line"><span class="go">SharedClass dtor:0x642f030</span>
</span><span class="line"><span class="go">	after	copy: 0	master: 0</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass ctor:0x642f0a0</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 0</span>
</span><span class="line"><span class="go">SharedClass ctor:0x642f030</span>
</span><span class="line"><span class="go">	after	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x642f0a0</span>
</span><span class="line"><span class="go">	before	copy: 2	master: 2</span>
</span><span class="line"><span class="go">SharedClass dtor:0x642f030</span>
</span><span class="line"><span class="go">	after	copy: 0	master: 0</span>
</span><span class="line">
</span><span class="line"><span class="go">Exiting main</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We can see that the singleton does in fact get destroyed prior to returning from
main(), which is what we want. We also see that the singleton gets destroyed
when nobody is using it, and automatically gets recreated if needed, which is
all well and good.</p>

<p>But, the code to make this happen does seem a bit messy, and potentially
unclear. Surely, there’s a better way to get the behavior we want without having
to directly manipulate reference counts.</p>

<p>Which brings us to shared_ptr’s cousin, the weak_ptr. A weak_ptr is similar to a
shared_ptr, except that assigning to a weak_ptr does not increment the shared
reference count:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span> (smart3.cpp)</span> <a href="/downloads/code/smart/smart3.cpp">download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
</pre></td><td class="code"><pre><code class="cpp"><span class="line"><span class="cp">#include &lt;iostream&gt;</span>
</span><span class="line"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class="line"><span class="cp">#include &lt;tr1/memory&gt;</span>
</span><span class="line"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">tr1</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="k">struct</span> <span class="n">SharedClass</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">SharedClass</span><span class="p">();</span>
</span><span class="line">   <span class="o">~</span><span class="n">SharedClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line"><span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="n">SharedClass</span><span class="o">::</span><span class="n">SharedClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SharedClass ctor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">SharedClass</span><span class="o">::~</span><span class="n">SharedClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;SharedClass dtor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">struct</span> <span class="n">ContainerClass</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="o">~</span><span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">getShared</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">	<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">memberPtr</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">	<span class="k">static</span> <span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span>  <span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line"><span class="p">};</span>
</span><span class="line">
</span><span class="line"><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span>   <span class="n">ContainerClass</span><span class="o">::</span><span class="n">masterPtr</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">ContainerClass</span><span class="o">::</span><span class="n">getShared</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SharedClass</span><span class="o">&gt;</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span><span class="line">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="n">temp</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">SharedClass</span><span class="p">());</span>
</span><span class="line">      <span class="n">masterPtr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span><span class="line">   <span class="p">}</span>
</span><span class="line">
</span><span class="line">   <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">ContainerClass</span><span class="o">::</span><span class="n">ContainerClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ContainerClass ctor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">before</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">memberPtr</span> <span class="o">=</span> <span class="n">getShared</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">after</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="n">ContainerClass</span><span class="o">::~</span><span class="n">ContainerClass</span><span class="p">()</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ContainerClass dtor:&quot;</span> <span class="o">&lt;&lt;</span> <span class="k">this</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">before</span><span class="se">\t</span><span class="s">copy: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">memberPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;master: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">masterPtr</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Entering main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass1</span><span class="p">;</span>
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass2</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">ContainerClass</span><span class="o">*</span> <span class="n">pClass3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerClass</span><span class="p">();</span>
</span><span class="line">   <span class="k">delete</span> <span class="n">pClass3</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exiting main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In this version, we change the code to use a weak_ptr instead of a shared_ptr
for the static class member that is initialized on creation of the singleton
object, and we remove the fiddling with reference counts that we had to do make
things come out right in the previous example.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span> (smart3.out)</span> <a href="/downloads/code/smart/smart3.out">download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="console"><span class="line"><span class="go">Entering main</span>
</span><span class="line"><span class="go">ContainerClass ctor:0x18bf8010</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 0</span>
</span><span class="line"><span class="go">SharedClass ctor:0x18bf8030</span>
</span><span class="line"><span class="go">	after	copy: 1	master: 1</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass ctor:0x18bf80a0</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 1</span>
</span><span class="line"><span class="go">	after	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x18bf8010</span>
</span><span class="line"><span class="go">	before	copy: 2	master: 2</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x18bf80a0</span>
</span><span class="line"><span class="go">	before	copy: 1	master: 1</span>
</span><span class="line">
</span><span class="line"><span class="go">SharedClass dtor:0x18bf8030</span>
</span><span class="line"><span class="go">ContainerClass ctor:0x18bf80a0</span>
</span><span class="line"><span class="go">	before	copy: 0	master: 0</span>
</span><span class="line"><span class="go">SharedClass ctor:0x18bf8030</span>
</span><span class="line"><span class="go">	after	copy: 1	master: 1</span>
</span><span class="line">
</span><span class="line"><span class="go">ContainerClass dtor:0x18bf80a0</span>
</span><span class="line"><span class="go">	before	copy: 1	master: 1</span>
</span><span class="line">
</span><span class="line"><span class="go">SharedClass dtor:0x18bf8030</span>
</span><span class="line"><span class="go">Exiting main</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Et voila – we can see that the behavior is exactly what we wanted, but without
the need to manipulate reference counts directly. Not to mention, the behavior
is a bit more like what one would expect (e.g., member variables get destroyed
on exit from the destructor, not in the body of the destructor).</p>

<h3 id="acknowledgements">Acknowledgements</h3>

<p>Thanks to the folks at cplusplus.com, especially “simeonz” for
<a href="http://www.cplusplus.com/forum/general/37113/">this post</a>, which discusses the
general problem and provides a nice code example that I used as the basis for
this discussion.</p>

<div class="footnotes">
  <ol>
    <li id="fn:2">
      <p>A free copy of the most recent working draft can be downloaded <a href="http://isocpp.org/files/papers/N3690.pdf">here</a>.<a href="#fnref:2" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:1">
      <p><a href="http://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization">http://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization</a><a href="#fnref:1" rel="reference">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bill Torpey</span></span>

      








  


<time datetime="2014-02-12T00:00:00-05:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/c-plus-plus/'>c++</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://btorpey.github.io/blog/2014/02/12/shared-singletons/" data-via="wallstprog" data-counturl="http://btorpey.github.io/blog/2014/02/12/shared-singletons/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/02/11/whats-old-is-new-again/" title="Previous Post: What's Old Is New Again">&laquo; What's Old Is New Again</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/02/13/how-did-i-get-here/" title="Next Post: You may ask yourself - "How did I get here?"">You may ask yourself - "How did I get here?" &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/07/14/memory-checking/">Memory Checking</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/17/lotso-static/">Lots o' static</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/10/join/">We Don't Need No Stinkin' Databases</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/12/even-mo-static/">Even Mo' Static</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/13/custom-tailor/">Custom-Tailored Configuration</a>
      </li>
    
  </ul>
</section>
<section>
  
  <a href="/about/index.html"><h1>About...</h1></a>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
Copyright &copy; 2019 - Bill Torpey. &nbsp; All Rights Reserved.
<br>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/deed.en_US">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.
<br>
<span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wallstprog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://btorpey.github.io/blog/2014/02/12/shared-singletons/';
        var disqus_url = 'http://btorpey.github.io/blog/2014/02/12/shared-singletons/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
